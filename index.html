<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evergrow</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="header-wrap">
    <header class="evergrow-header">
        <div class="header-inner">
            <div class="header-logo-group">
                <img src="images/left-decor.png" alt="" class="header-img header-left">
                <img src="images/logo.png" alt="Evergrow" class="header-logo">
                <img src="images/right-decor.png" alt="" class="header-img header-right">
            </div>
        </div>
    </header>
    <nav class="nav-below-header">
        <a href="stats.html" class="nav-link-top">Scoreboard &amp; Upgrades â†’</a>
        <button type="button" class="help-btn" id="helpBtn">Help</button>
    </nav>
    </div>

    <div class="game-container clicker-only">

        <!-- Click Area -->
        <div class="panel click-area">
            <h2 class="click-instruction">Click the tree to add blossoms</h2>
            <p class="blossom-count">Blossoms on tree: <span id="crystalCount">0</span></p>
            <div class="tree-wrapper">
            <div class="tree-stage" id="treeStage">
                <img class="tree-bare" id="treeBare" src="images/empty-tree.png" alt="">
                <div class="tree-blossoms" id="treeBlossoms"></div>
                <button class="tree-hit-area" id="clickBtn" aria-label="Click tree to add cherry blossoms"></button>
            </div>
            </div>
            <p class="click-text">Each click adds <span class="click-value" id="clickValueDisplay">+1</span> blossom<span id="pluralS">s</span></p>
            <div class="auto-indicator" id="autoIndicator">
                <p>Blossoms drifting in: <span class="auto-value" id="autoValue">0</span>/sec</p>
            </div>
            <button type="button" class="reset-btn" id="resetBtn">Reset tree</button>
        </div>
    </div>

    <div class="overlay" id="resetOverlay" aria-hidden="true">
        <div class="overlay-panel">
            <p>Reset the tree and all progress? Blossoms and upgrades will be cleared.</p>
            <div class="overlay-actions">
                <button type="button" id="resetConfirmBtn">Yes</button>
                <button type="button" id="resetCancelBtn">No</button>
            </div>
        </div>
    </div>

    <div class="help-panel" id="helpPanel" aria-hidden="true">
        <h3>How to play</h3>
        <p>click anywhere on the tree to add blossoms. every time you click gives blossoms based on your click value. you can spend acquired blossoms on the scoreboard &amp; upgrades page to buy upgrades. a few upgrades increase blossoms per click while others add automatic blossoms per second. earn achievements by reaching milestones.</p>
        <h3>Upgrades</h3>
        <ul id="helpUpgradesList"></ul>
        <h3>Rewards (Achievements)</h3>
        <ul id="helpRewardsList"></ul>
        <button type="button" id="helpCloseBtn">Close</button>
    </div>

    <script>
        window.addEventListener('load', function () {
        const gameState = {
            crystals: 0,
            totalCrystals: 0,
            clickValue: 1,
            totalClicks: 0,
            autoClickValue: 0,
            upgrades: {},
            achievements: new Set()
        };

        const clickBtn = document.getElementById('clickBtn');
        const crystalCountEl = document.getElementById('crystalCount');
        const clickValueDisplayEl = document.getElementById('clickValueDisplay');
        const autoIndicatorEl = document.getElementById('autoIndicator');
        const autoValueEl = document.getElementById('autoValue');
        const pluralEl = document.getElementById('pluralS');
        const treeBlossomsEl = document.getElementById('treeBlossoms');

        const BLOSSOM_MAX = 200;
        const BLOSSOM_IMG = 'images/cherry-blossom.png';

        function addBlossomAt(percentX, percentY) {
            const img = document.createElement('img');
            img.src = BLOSSOM_IMG;
            img.alt = '';
            img.className = 'blossom-petal';
            img.style.left = percentX + '%';
            img.style.top = percentY + '%';
            treeBlossomsEl.appendChild(img);
        }

        function trimBlossomsToMax() {
            while (treeBlossomsEl.children.length > BLOSSOM_MAX) {
                treeBlossomsEl.removeChild(treeBlossomsEl.firstChild);
            }
        }

        function resetTree() {
            treeBlossomsEl.innerHTML = '';
            gameState.crystals = 0;
            gameState.totalCrystals = 0;
            gameState.clickValue = 1;
            gameState.totalClicks = 0;
            gameState.autoClickValue = 0;
            gameState.upgrades = {};
            gameState.achievements = new Set();
            updateUI();
            saveGame();
        }

        // Tree boundary: entire tree area (trunk, branches, canopy) is clickable.
        function isInsideTreeBoundary(percentX, percentY) {
            return percentX >= 0 && percentX <= 100 && percentY >= 0 && percentY <= 100;
        }

        function randomTreePosition() {
            return {
                x: 5 + Math.random() * 90,
                y: 5 + Math.random() * 90
            };
        }

        function seedBlossomsForLoad() {
            const n = Math.min(Math.floor(gameState.crystals), BLOSSOM_MAX);
            for (let i = 0; i < n; i++) {
                const p = randomTreePosition();
                addBlossomAt(p.x, p.y);
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.floor(num).toString();
        }

        function createFloatingNumber(x, y, value) {
            const el = document.createElement('div');
            el.className = 'float-number';
            el.textContent = '+' + formatNumber(value);
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function updateUI() {
            crystalCountEl.textContent = formatNumber(gameState.crystals);
            clickValueDisplayEl.textContent = '+' + formatNumber(gameState.clickValue);
            if (pluralEl) pluralEl.textContent = gameState.clickValue === 1 ? '' : 's';
            if (gameState.autoClickValue > 0) {
                autoIndicatorEl.classList.add('active');
                autoValueEl.textContent = formatNumber(gameState.autoClickValue);
            }
        }

        clickBtn.addEventListener('click', (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const percentX = ((e.clientX - rect.left) / rect.width) * 100;
            const percentY = ((e.clientY - rect.top) / rect.height) * 100;
            if (!isInsideTreeBoundary(percentX, percentY)) return;
            const currentCount = treeBlossomsEl.children.length;
            const canAdd = Math.min(gameState.clickValue, BLOSSOM_MAX - currentCount);
            for (let i = 0; i < canAdd; i++) {
                const offset = (i - canAdd / 2) * 3;
                const px = percentX + (Math.random() - 0.5) * 8 + offset;
                const py = percentY + (Math.random() - 0.5) * 8;
                if (isInsideTreeBoundary(px, py)) {
                    addBlossomAt(px, py);
                } else {
                    addBlossomAt(percentX, percentY);
                }
            }
            gameState.crystals += gameState.clickValue;
            gameState.totalCrystals += gameState.clickValue;
            gameState.totalClicks++;
            createFloatingNumber(e.clientX, e.clientY, gameState.clickValue);
            updateUI();
        });

        setInterval(() => {
            if (gameState.autoClickValue > 0) {
                const currentCount = treeBlossomsEl.children.length;
                const canAdd = Math.min(gameState.autoClickValue, BLOSSOM_MAX - currentCount);
                for (let i = 0; i < canAdd; i++) {
                    const p = randomTreePosition();
                    addBlossomAt(p.x, p.y);
                }
                gameState.crystals += gameState.autoClickValue;
                gameState.totalCrystals += gameState.autoClickValue;
                updateUI();
            }
        }, 1000);

        function saveGame() {
            const saveData = {
                crystals: gameState.crystals,
                totalCrystals: gameState.totalCrystals,
                clickValue: gameState.clickValue,
                totalClicks: gameState.totalClicks,
                autoClickValue: gameState.autoClickValue,
                upgrades: gameState.upgrades,
                achievements: Array.from(gameState.achievements)
            };
            localStorage.setItem('crystalClickerSave', JSON.stringify(saveData));
        }

        function loadGame() {
            const saved = localStorage.getItem('crystalClickerSave');
            if (saved) {
                const data = JSON.parse(saved);
                gameState.crystals = data.crystals || 0;
                gameState.totalCrystals = data.totalCrystals || 0;
                gameState.clickValue = data.clickValue || 1;
                gameState.totalClicks = data.totalClicks || 0;
                gameState.autoClickValue = data.autoClickValue || 0;
                gameState.upgrades = data.upgrades || {};
                gameState.achievements = new Set(data.achievements || []);
            }
        }

        loadGame();
        seedBlossomsForLoad();
        updateUI();

        document.getElementById('resetBtn').addEventListener('click', function () {
            document.getElementById('resetOverlay').setAttribute('aria-hidden', 'false');
            document.getElementById('resetOverlay').classList.add('visible');
        });
        document.getElementById('resetConfirmBtn').addEventListener('click', function () {
            resetTree();
            document.getElementById('resetOverlay').classList.remove('visible');
            document.getElementById('resetOverlay').setAttribute('aria-hidden', 'true');
        });
        document.getElementById('resetCancelBtn').addEventListener('click', function () {
            document.getElementById('resetOverlay').classList.remove('visible');
            document.getElementById('resetOverlay').setAttribute('aria-hidden', 'true');
        });

        const helpPanel = document.getElementById('helpPanel');
        const helpUpgradesList = document.getElementById('helpUpgradesList');
        const helpRewardsList = document.getElementById('helpRewardsList');
        const upgradesHelp = [
            'gentle breeze: +1 blossom per click',
            'soft wind: +2 blossoms per click',
            'Butterflies: +1 blossom/sec (auto)',
            'spring gust: +5 blossoms per click',
            'garden breeze: +5 blossoms/sec (auto)',
            'blossom storm: +20 blossoms per click',
            'petal shower: +25 blossoms/sec (auto)',
            'full bloom: +100 blossoms/sec (auto)'
        ];
        const rewardsHelp = [
            'first touch: Touch the tree once',
            'tender care: 100 touches',
            'tree friend: 1,000 touches',
            'blossom bud: 100 total blossoms',
            'blossom bloom: 1,000 total',
            'blossom grove: 10,000 total',
            'blossom haven: 100,000 total',
            'first upgrade: buy first upgrade',
            'growing garden: 10 upgrades',
            'blossom keeper: 25 upgrades',
            'breeze arrives: first auto blossoms',
            'peak bloom: 50 blossoms per click'
        ];
        upgradesHelp.forEach(function (text) { const li = document.createElement('li'); li.textContent = text; helpUpgradesList.appendChild(li); });
        rewardsHelp.forEach(function (text) { const li = document.createElement('li'); li.textContent = text; helpRewardsList.appendChild(li); });
        document.getElementById('helpBtn').addEventListener('click', function () {
            helpPanel.classList.toggle('visible');
            helpPanel.setAttribute('aria-hidden', helpPanel.classList.contains('visible') ? 'false' : 'true');
        });
        document.getElementById('helpCloseBtn').addEventListener('click', function () {
            helpPanel.classList.remove('visible');
            helpPanel.setAttribute('aria-hidden', 'true');
        });

        setInterval(saveGame, 30000);
        window.addEventListener('beforeunload', saveGame);
        });
    </script>
</body>
</html>
